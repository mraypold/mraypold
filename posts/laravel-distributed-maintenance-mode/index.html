<!DOCTYPE html>
<html lang="en-us">
<head>
  <link rel="preload" href="/lib/font-awesome/webfonts/fa-brands-400.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" href="/lib/font-awesome/webfonts/fa-regular-400.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" href="/lib/font-awesome/webfonts/fa-solid-900.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" href="/lib/JetBrainsMono/web/woff2/JetBrainsMono-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title> Laravel Distributed Maintenance Mode | Michael Raypold</title>
  <link rel = 'canonical' href = '/posts/laravel-distributed-maintenance-mode/'>
  <meta name="description" content="Thoughts of Michael Raypold. The wonderful Hugo theme has been developed by [monkeyWzr](https://github.com/monkeyWzr/).">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="robots" content="all,follow">
  <meta name="googlebot" content="index,follow,snippet,archive">
  <meta property="og:title" content="Laravel Distributed Maintenance Mode" />
<meta property="og:description" content="The Laravel maintainers have begun to invest more time in providing features and tooling for managing Laravel in a distributed environment.
Laravel 5.4 modified the withoutOverlapping() option for kernel tasks (PR #16196) to use the cache to create a lock and prevent overlapping scheduled tasks across instances.
Laravel Horizon makes it easier to monitor and maintain Laravel powered Redis queues in both a distributed and single instance deployment.
Laravel 5.5 includes TrustedProxy so that you can more easily place your application behind a load balancer." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/laravel-distributed-maintenance-mode/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2017-10-07T06:50:24-07:00" />
<meta property="article:modified_time" content="2017-10-07T06:50:24-07:00" />


  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Laravel Distributed Maintenance Mode"/>
<meta name="twitter:description" content="The Laravel maintainers have begun to invest more time in providing features and tooling for managing Laravel in a distributed environment.
Laravel 5.4 modified the withoutOverlapping() option for kernel tasks (PR #16196) to use the cache to create a lock and prevent overlapping scheduled tasks across instances.
Laravel Horizon makes it easier to monitor and maintain Laravel powered Redis queues in both a distributed and single instance deployment.
Laravel 5.5 includes TrustedProxy so that you can more easily place your application behind a load balancer."/>

  
  
    
  
  
  <link rel="stylesheet" href="/css/styles.94f653e9e151e28067a7c5dbbc4600cbd5a3c721e79faaf971e523c40f3b249b8e4f20bb57810dfffa8d559ca5c140fd56eb4cd9c0853113ad08e66afdb08bdd.css" integrity="sha512-lPZT6eFR4oBnp8XbvEYAy9WjxyHnn6r5ceUjxA87JJuOTyC7V4EN//qNVZylwUD9VutM2cCFMROtCOZq/bCL3Q=="> 

  
  
  
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  

  
<link rel="icon" type="image/png" href="/images/favicon.ico" />

  
  
</head>

<body class="max-width mx-auto px3 ltr">
  <div class="content index py4">

  <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;" aria-label="Top of Page"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
        <li><a href="/">Home</a></li>
         
        <li><a href="/posts">All posts</a></li>
         
        <li><a href="/tags">Tags</a></li>
         
        <li><a href="/about">About</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li>
          <a class="icon" href=" /about/" aria-label="Previous">
            <i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i>
          </a>
        </li>
        
        
        <li>
          <a class="icon" href="/posts/laravel-queues-in-production/" aria-label="Next">
            <i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i>
          </a>
        </li>
        
        <li>
          <a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" aria-label="Top of Page">
            <i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i>
          </a>
        </li>
        <li>
          <a class="icon" href="#" aria-label="Share">
            <i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i>
          </a>
        </li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      
      <ul>
  
  
    
  
  
  <li>
    <a class="icon" href="http://www.facebook.com/sharer.php?u=%2fposts%2flaravel-distributed-maintenance-mode%2f" aria-label="Facebook">
      <i class="fab fa-facebook " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://twitter.com/share?url=%2fposts%2flaravel-distributed-maintenance-mode%2f&text=Laravel%20Distributed%20Maintenance%20Mode" aria-label="Twitter">
      <i class="fab fa-twitter " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.linkedin.com/shareArticle?url=%2fposts%2flaravel-distributed-maintenance-mode%2f&title=Laravel%20Distributed%20Maintenance%20Mode" aria-label="Linkedin">
      <i class="fab fa-linkedin " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=%2fposts%2flaravel-distributed-maintenance-mode%2f&is_video=false&description=Laravel%20Distributed%20Maintenance%20Mode" aria-label="Pinterest">
      <i class="fab fa-pinterest " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="mailto:?subject=Laravel%20Distributed%20Maintenance%20Mode&body=Check out this article: %2fposts%2flaravel-distributed-maintenance-mode%2f" aria-label="Email">
      <i class="fas fa-envelope " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://getpocket.com/save?url=%2fposts%2flaravel-distributed-maintenance-mode%2f&title=Laravel%20Distributed%20Maintenance%20Mode" aria-label="Pocket">
      <i class="fab fa-get-pocket " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://reddit.com/submit?url=%2fposts%2flaravel-distributed-maintenance-mode%2f&title=Laravel%20Distributed%20Maintenance%20Mode" aria-label="reddit">
      <i class="fab fa-reddit " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.tumblr.com/share/link?url=%2fposts%2flaravel-distributed-maintenance-mode%2f&name=Laravel%20Distributed%20Maintenance%20Mode&description=The%20Laravel%20maintainers%20have%20begun%20to%20invest%20more%20time%20in%20providing%20features%20and%20tooling%20for%20managing%20Laravel%20in%20a%20distributed%20environment.%0aLaravel%205.4%20modified%20the%20withoutOverlapping%28%29%20option%20for%20kernel%20tasks%20%28PR%20%2316196%29%20to%20use%20the%20cache%20to%20create%20a%20lock%20and%20prevent%20overlapping%20scheduled%20tasks%20across%20instances.%0aLaravel%20Horizon%20makes%20it%20easier%20to%20monitor%20and%20maintain%20Laravel%20powered%20Redis%20queues%20in%20both%20a%20distributed%20and%20single%20instance%20deployment.%0aLaravel%205.5%20includes%20TrustedProxy%20so%20that%20you%20can%20more%20easily%20place%20your%20application%20behind%20a%20load%20balancer." aria-label="Tumblr">
      <i class="fab fa-tumblr " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://news.ycombinator.com/submitlink?u=%2fposts%2flaravel-distributed-maintenance-mode%2f&t=Laravel%20Distributed%20Maintenance%20Mode" aria-label="Hacker News">
      <i class="fab fa-hacker-news " aria-hidden="true"></i>
    </a>
  </li>
</ul>

    </div>
    <div id="toc">
      <nav id="TableOfContents">
  <ul>
    <li><a href="#why-do-we-need-maintenance-mode">Why Do We Need Maintenance Mode</a></li>
    <li><a href="#how-does-maintenance-mode-work">How Does Maintenance Mode Work</a></li>
    <li><a href="#why-the-current-solution-doesntt-work-in-a-distributed-environment">Why the Current Solution Doesnt&rsquo;t Work in a Distributed Environment</a></li>
    <li><a href="#solving-distributed-maintenance-mode">Solving Distributed Maintenance Mode.</a>
      <ul>
        <li><a href="#plan-of-attack">Plan of Attack</a></li>
        <li><a href="#creating-the-enums">Creating the Enums</a></li>
        <li><a href="#extending-artisan-down">Extending Artisan Down</a></li>
        <li><a href="#extending-artisan-up">Extending Artisan Up</a></li>
        <li><a href="#register-the-new-commands">Register the New Commands</a></li>
        <li><a href="#extend-laravels-application-class">Extend Laravel&rsquo;s Application Class</a></li>
        <li><a href="#extending-maintenance-mode-middleware">Extending Maintenance Mode Middleware</a></li>
        <li><a href="#tests">Tests</a></li>
      </ul>
    </li>
    <li><a href="#production-environment-performance-difference">Production Environment Performance Difference</a></li>
    <li><a href="#what-you-should-be-aware-of">What You Should Be Aware Of</a></li>
    <li><a href="#conclusion">Conclusion</a></li>
  </ul>
</nav>
    </div>
  </span>
</div>


  <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
    <header>
      <h1 class="posttitle" itemprop="name headline">
        Laravel Distributed Maintenance Mode
      </h1>
      <div class="meta">
        
        <div class="postdate">
          
          <time datetime="2017-10-07 06:50:24 -0700 PDT" itemprop="datePublished">2017-10-07</time>
          
        </div>
        
        
        
        
        <div class="article-tag">
            <i class="fas fa-tag"></i>
            
            
            <a class="tag-link" href="/tags/laravel" rel="tag">Laravel</a>
            
             ,  
            <a class="tag-link" href="/tags/php" rel="tag">PHP</a>
            
             ,  
            <a class="tag-link" href="/tags/redis" rel="tag">Redis</a>
            
        </div>
        
      </div>
    </header>

  
    <div class="content" itemprop="articleBody">
      <p>The Laravel maintainers have begun to invest more time in providing features and tooling for managing Laravel in a distributed environment.</p>
<p>Laravel 5.4 modified the <code>withoutOverlapping()</code> option for kernel tasks (<a href="https://github.com/laravel/framework/pull/16196">PR #16196</a>) to use the cache to create a lock and prevent overlapping scheduled tasks across instances.</p>
<p><a href="https://github.com/laravel/horizon">Laravel Horizon</a> makes it easier to monitor and maintain Laravel powered Redis queues in both a distributed and single instance deployment.</p>
<p><a href="https://laravel-news.com/trusted-proxy">Laravel 5.5 includes TrustedProxy</a> so that you can more easily place your application behind a load balancer.</p>
<p>What is still missing, is the ability to put the application into maintenance mode when running multiple Laravel instances behind a load balancer.</p>
<p>If you don&rsquo;t need to put your app in maintenance mode, but simply need to prevent people from accessing the site for a short time, the easiest option might be to point your domain to a static maintenance page for a while. For example, you could use <a href="http://docs.aws.amazon.com/Route53/latest/DeveloperGuide/RoutingToS3Bucket.html">Route53 to redirect traffic to an s3 bucket</a> containing a maintenance page.</p>
<h2 id="why-do-we-need-maintenance-mode">Why Do We Need Maintenance Mode</h2>
<p><a href="https://laravel.com/docs/5.5/configuration#maintenance-mode">Maintenance mode</a> displays a maintenance page to visitors as well as prevents queued jobs from running.</p>
<p>Therefore, if you are using the Laravel job queue or scheduled tasks, simply pointing your domain to a static maintenance page is not an ideal solution, as background jobs will continue to run and interact with your database and cache.</p>
<p>If you have unexpected long running migration, or you need to perform emergency maintenance on a Laravel deployment that has background tasks, re-routing traffic to a static maintenance page is not an ideal solution.</p>
<h2 id="how-does-maintenance-mode-work">How Does Maintenance Mode Work</h2>
<p>The built in <code>php artisan down</code> command that puts the app into maintenance mode, places a temporary file in the app&rsquo;s storage directory at <code>/framework/down</code>. You can find the code for the <code>DownCommand</code> code <a href="https://github.com/laravel/framework/blob/bd352a0d2ca93775fce8ef02365b03fc4fb8cbb0/src/Illuminate/Foundation/Console/DownCommand.php">here</a>.</p>
<p>When a request is processed by Laravel, it is either handled by the <a href="https://laravel.com/docs/5.5/lifecycle">HTTP or console kernel</a>.</p>
<p>The HTTP kernel is generally the bulk of your application requests and passes through the global HTTP middleware and middleware groups before being sent to your routing files.</p>
<p>The console kernel is used for any scheduled tasks you define.</p>
<p>Both kernels will pass through a <code>CheckForMaintenanceMode</code> middleware that checks if the application is currently in maintenance mode, which then throws an exception that is handled appropriately in the <code>app\Excpetions\Handler.php</code> file.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#e6db74">/**
</span><span style="color:#e6db74"> * Handle an incoming request.
</span><span style="color:#e6db74"> *
</span><span style="color:#e6db74"> * @param  \Illuminate\Http\Request  $request
</span><span style="color:#e6db74"> * @param  \Closure  $next
</span><span style="color:#e6db74"> * @return mixed
</span><span style="color:#e6db74"> *
</span><span style="color:#e6db74"> * @throws \Symfony\Component\HttpKernel\Exception\HttpException
</span><span style="color:#e6db74"> */</span>
 <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">handle</span>($request, <span style="color:#a6e22e">Closure</span> $next)
 {
      <span style="color:#66d9ef">if</span> ($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">app</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">isDownForMaintenance</span>()) {
        $data <span style="color:#f92672">=</span> <span style="color:#a6e22e">json_decode</span>(<span style="color:#a6e22e">file_get_contents</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">app</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">storagePath</span>()<span style="color:#f92672">.</span><span style="color:#e6db74">&#39;/framework/down&#39;</span>), <span style="color:#66d9ef">true</span>);
        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">MaintenanceModeException</span>($data[<span style="color:#e6db74">&#39;time&#39;</span>], $data[<span style="color:#e6db74">&#39;retry&#39;</span>], $data[<span style="color:#e6db74">&#39;message&#39;</span>]);
      }
      <span style="color:#66d9ef">return</span> $next($request);
 }
</code></pre></div><p>source <a href="https://github.com/laravel/framework/blob/bd352a0d2ca93775fce8ef02365b03fc4fb8cbb0/src/Illuminate/Foundation/Http/Middleware/CheckForMaintenanceMode.php">CheckForMaintenanceMode.php</a></p>
<p>Similar checks are made in the <code>Worker.php</code> and the <code>QueueManager.php</code> files.</p>
<p>Finally, the <code>isDownForMaintenance()</code> command is handled in your application container.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#e6db74">/**
</span><span style="color:#e6db74"> * Determine if the application is currently down for maintenance.
</span><span style="color:#e6db74"> *
</span><span style="color:#e6db74"> * @return bool
</span><span style="color:#e6db74"> */</span>
 <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">isDownForMaintenance</span>()
 {
     <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">file_exists</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">storagePath</span>()<span style="color:#f92672">.</span><span style="color:#e6db74">&#39;/framework/down&#39;</span>);
 }
</code></pre></div><p>source <a href="https://github.com/laravel/framework/blob/26c700eb79e5bb55b59df2c495c9c71f16f43302/src/Illuminate/Foundation/Application.php#L903">Application.php</a></p>
<h2 id="why-the-current-solution-doesntt-work-in-a-distributed-environment">Why the Current Solution Doesnt&rsquo;t Work in a Distributed Environment</h2>
<p>If your storage directory is shared across all your deployed instances, the current solution is fine.</p>
<p>For many deployments, we don&rsquo;t share storage directories across all instances because we don&rsquo;t handle file uploads.</p>
<p>It is also possible that your job queue is managed on a different server than that which is serving your webapp.</p>
<h2 id="solving-distributed-maintenance-mode">Solving Distributed Maintenance Mode.</h2>
<p>Thankfully, we can follow a similar approach outlined in <a href="https://github.com/laravel/framework/pull/16196">PR #16196</a> where a lock is checked to confirm that the kernel command is not already running elsewhere.</p>
<p>By using the cache, we can set a maintenance mode lock in Redis that is checked by all deployed instances before continuing the request lifecycle.</p>
<h3 id="plan-of-attack">Plan of Attack</h3>
<ul>
<li>Create a maintenance mode enum.</li>
<li>Extend the <code>php artisan down</code> command and override the <code>handle</code> function.</li>
<li>Extend the <code>php artisan up</code> command and override the <code>handle</code> function.</li>
<li>Register the commands in the service provider and kernel.</li>
<li>Extend the application and override the <code>isDownForMaintenance</code> function.</li>
<li>Extend the CheckForMaintenanceMode middleware and override the <code>handle</code> function.</li>
</ul>
<h3 id="creating-the-enums">Creating the Enums</h3>
<p>The first thing that we will do is create some enums for common string based cache keys that will be used throughout the maintenance mode code.</p>
<p>The reason we&rsquo;re using enums is so that we can easily update the cache key without having to hunt down and potentially miss references throughout the application if we ever want to update the keys in the future.</p>
<p>Here, I&rsquo;m just using an abstract class, but you could alternatively put these in a config file.</p>
<p>I find this approach cleaner and use it frequently.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>

<span style="color:#66d9ef">namespace</span> <span style="color:#a6e22e">App\Utils\Enums</span>;

<span style="color:#66d9ef">abstract</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CacheKeys</span>
{
    <span style="color:#e6db74">/**
</span><span style="color:#e6db74">     * @var string A cache accessor for maintenance mode
</span><span style="color:#e6db74">     */</span>
    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">MAINTENANCE_PAYLOAD</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;laravel-maintenance-mode-payload&#39;</span>;
}
</code></pre></div><h3 id="extending-artisan-down">Extending Artisan Down</h3>
<p>Next, extend Laravel&rsquo;s down command to use the cache instead of the filesystem.</p>
<p>Notice that <code>CacheKeys::MAINTENANCE_PAYLOAD</code> references the enum we created above. This will be used in all the extensions that are created.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>

<span style="color:#66d9ef">namespace</span> <span style="color:#a6e22e">App\Console\Commands</span>;

<span style="color:#66d9ef">use</span> <span style="color:#a6e22e">App\Utils\Enums\CacheKeys</span>;
<span style="color:#66d9ef">use</span> <span style="color:#a6e22e">Cache</span>;
<span style="color:#66d9ef">use</span> <span style="color:#a6e22e">Illuminate\Foundation\Console\DownCommand</span> <span style="color:#66d9ef">as</span> <span style="color:#a6e22e">Down</span>;

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">DownCommand</span> <span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">Down</span>
{
    <span style="color:#e6db74">/**
</span><span style="color:#e6db74">     * Execute the console command.
</span><span style="color:#e6db74">     *
</span><span style="color:#e6db74">     * Overrides Laravel&#39;s DownCommand to use the cache instead of the
</span><span style="color:#e6db74">     * filesystem so that maintenance mode is propagated across all
</span><span style="color:#e6db74">     * servers and job queues.
</span><span style="color:#e6db74">     *
</span><span style="color:#e6db74">     * @return mixed
</span><span style="color:#e6db74">     */</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">handle</span>()
    {
        <span style="color:#a6e22e">Cache</span><span style="color:#f92672">::</span><span style="color:#a6e22e">forever</span>(<span style="color:#a6e22e">CacheKeys</span><span style="color:#f92672">::</span><span style="color:#a6e22e">MAINTENANCE_PAYLOAD</span>, <span style="color:#a6e22e">json_encode</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">getDownFilePayload</span>()));
        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">comment</span>(<span style="color:#e6db74">&#39;Application is now in maintenance mode.&#39;</span>);
    }
}
</code></pre></div><p>The <code>$this-&gt;getDownFilePayload</code> serializes the options passed into the Artisan command at runtime and is in the original <code>Down</code> class.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#e6db74">/**
</span><span style="color:#e6db74"> * Get the payload to be placed in the &#34;down&#34; file.
</span><span style="color:#e6db74"> *
</span><span style="color:#e6db74"> * @return array
</span><span style="color:#e6db74"> */</span>
<span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">getDownFilePayload</span>()
{
    <span style="color:#66d9ef">return</span> [
        <span style="color:#e6db74">&#39;time&#39;</span> <span style="color:#f92672">=&gt;</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">currentTime</span>(),
        <span style="color:#e6db74">&#39;message&#39;</span> <span style="color:#f92672">=&gt;</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">option</span>(<span style="color:#e6db74">&#39;message&#39;</span>),
        <span style="color:#e6db74">&#39;retry&#39;</span> <span style="color:#f92672">=&gt;</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">getRetryTime</span>(),
    ];
}
</code></pre></div><p>If you wish, you can use the <code>retry</code> field to have the cache automatically purge the key/value after the given period of time and take the application out of maintenance mode.</p>
<h3 id="extending-artisan-up">Extending Artisan Up</h3>
<p>Now, extend Laravel&rsquo;s up command to purge the cache key that is being used as a lock, thus taking the application out of maintenance mode.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>

<span style="color:#66d9ef">namespace</span> <span style="color:#a6e22e">App\Console\Commands</span>;

<span style="color:#66d9ef">use</span> <span style="color:#a6e22e">App\Utils\Enums\CacheKeys</span>;
<span style="color:#66d9ef">use</span> <span style="color:#a6e22e">Cache</span>;
<span style="color:#66d9ef">use</span> <span style="color:#a6e22e">Illuminate\Foundation\Console\UpCommand</span> <span style="color:#66d9ef">as</span> <span style="color:#a6e22e">Up</span>;

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UpCommand</span> <span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">Up</span>
{
    <span style="color:#e6db74">/**
</span><span style="color:#e6db74">     * Execute the console command.
</span><span style="color:#e6db74">     *
</span><span style="color:#e6db74">     * Overrides Laravel&#39;s UpCommand to use the cache instead of the
</span><span style="color:#e6db74">     * filesystem so that maintenance mode is propagated across all
</span><span style="color:#e6db74">     * servers and job queues.
</span><span style="color:#e6db74">     *
</span><span style="color:#e6db74">     * @return mixed
</span><span style="color:#e6db74">     */</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">handle</span>()
    {
        <span style="color:#a6e22e">Cache</span><span style="color:#f92672">::</span><span style="color:#a6e22e">forget</span>(<span style="color:#a6e22e">CacheKeys</span><span style="color:#f92672">::</span><span style="color:#a6e22e">MAINTENANCE_PAYLOAD</span>);
        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">info</span>(<span style="color:#e6db74">&#39;Application is now live.&#39;</span>);
    }
}
</code></pre></div><h3 id="register-the-new-commands">Register the New Commands</h3>
<p>Now that we have extended the necessary core Laravel commands, we need to tell the application that when it is bootstrapped, it should use the modified commands instead of the Illuminate commands that ship with the framework.</p>
<p>This can easily be accomplished in the <code>AppServiceProvider</code> boot method.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#e6db74">/**
</span><span style="color:#e6db74"> * Bootstrap any application services.
</span><span style="color:#e6db74"> *
</span><span style="color:#e6db74"> * @return void
</span><span style="color:#e6db74"> */</span>
 <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">boot</span>()
 {
    <span style="color:#e6db74">/**
</span><span style="color:#e6db74">     * Override Laravel&#39;s &#34;php artisan down&#34; command to put the application in maintenance mode
</span><span style="color:#e6db74">     * using our custom Redis based lock.
</span><span style="color:#e6db74">     */</span>
    $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">app</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">extend</span>(<span style="color:#e6db74">&#39;command.down&#39;</span>, <span style="color:#66d9ef">function</span> () {
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">DownCommand</span>();
    });

    <span style="color:#e6db74">/**
</span><span style="color:#e6db74">     * Override Laravel&#39;s &#34;php artisan up&#34; command to bring the application out of maintenance mode
</span><span style="color:#e6db74">     * using our custom Redis based lock.
</span><span style="color:#e6db74">     */</span>
     $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">app</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">extend</span>(<span style="color:#e6db74">&#39;command.up&#39;</span>, <span style="color:#66d9ef">function</span> () {
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">UpCommand</span>();
    });
}
</code></pre></div><p>Remember to import the commands.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#66d9ef">use</span> <span style="color:#a6e22e">App\Console\Commands\DownCommand</span>;
<span style="color:#66d9ef">use</span> <span style="color:#a6e22e">App\Console\Commands\UpCommand</span>;
</code></pre></div><p>You will also need to add the commands to the console kernel like you do all other commands.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>

<span style="color:#66d9ef">namespace</span> <span style="color:#a6e22e">App\Console</span>;

<span style="color:#66d9ef">use</span> <span style="color:#a6e22e">App\Console\Commands\DownCommand</span>;
<span style="color:#66d9ef">use</span> <span style="color:#a6e22e">App\Console\Commands\UpCommand</span>;
<span style="color:#66d9ef">use</span> <span style="color:#a6e22e">Illuminate\Foundation\Console\Kernel</span> <span style="color:#66d9ef">as</span> <span style="color:#a6e22e">ConsoleKernel</span>;

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Kernel</span> <span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">ConsoleKernel</span>
{
    <span style="color:#e6db74">/**
</span><span style="color:#e6db74">     * The Artisan commands provided by your application.
</span><span style="color:#e6db74">     *
</span><span style="color:#e6db74">     * @var array
</span><span style="color:#e6db74">     */</span>
    <span style="color:#66d9ef">protected</span> $commands <span style="color:#f92672">=</span> [
        <span style="color:#a6e22e">DownCommand</span><span style="color:#f92672">::</span><span style="color:#a6e22e">class</span>,
        <span style="color:#a6e22e">UpCommand</span><span style="color:#f92672">::</span><span style="color:#a6e22e">class</span>,
    ];

    <span style="color:#e6db74">/**
</span><span style="color:#e6db74">     * Register the Closure based commands for the application.
</span><span style="color:#e6db74">     *
</span><span style="color:#e6db74">     * @return void
</span><span style="color:#e6db74">     */</span>
    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">commands</span>()
    {
        <span style="color:#66d9ef">require</span> <span style="color:#a6e22e">base_path</span>(<span style="color:#e6db74">&#39;routes/console.php&#39;</span>);
    }
}
</code></pre></div><h3 id="extend-laravels-application-class">Extend Laravel&rsquo;s Application Class</h3>
<p>Now that we are using the cache instead of the filesystem to store the maintenance mode lock, the framework needs to be directed to the new location so that it knows when the application is in maintenance mode.</p>
<p>First, extend the core Application class so that we can override Laravel&rsquo;s <code>isDownForMaintenance</code> method that is currently checking the filesystem for the maintenance lock.</p>
<p>I&rsquo;ve created an <code>App\Extensions\Illuminate\Foundation</code> directory in an attempt to closely mirror the framework.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>

<span style="color:#66d9ef">namespace</span> <span style="color:#a6e22e">App\Extensions\Illuminate\Foundation</span>;

<span style="color:#66d9ef">use</span> <span style="color:#a6e22e">App\Utils\Enums\CacheKeys</span>;
<span style="color:#66d9ef">use</span> <span style="color:#a6e22e">Cache</span>;
<span style="color:#66d9ef">use</span> <span style="color:#a6e22e">Illuminate\Foundation\Application</span> <span style="color:#66d9ef">as</span> <span style="color:#a6e22e">App</span>;

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Application</span> <span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">App</span>
{
    <span style="color:#e6db74">/**
</span><span style="color:#e6db74">     * Returns whether the application is down for maintenance.
</span><span style="color:#e6db74">     *
</span><span style="color:#e6db74">     * Laravel maintenance mode is overridden to use the cache instead of the filesystem,
</span><span style="color:#e6db74">     * allowing us to treat Redis as a global distributed lock so that
</span><span style="color:#e6db74">     * maintenance mode is propagated to multiple servers.
</span><span style="color:#e6db74">     *
</span><span style="color:#e6db74">     * @return bool Whether the app is in maintenance mod.
</span><span style="color:#e6db74">     */</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">isDownForMaintenance</span>()
    {
        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">Cache</span><span style="color:#f92672">::</span><span style="color:#a6e22e">has</span>(<span style="color:#a6e22e">CacheKeys</span><span style="color:#f92672">::</span><span style="color:#a6e22e">MAINTENANCE_PAYLOAD</span>);
    }
}
</code></pre></div><p>This next step that needs to be taken when extending the application is to change how the web application is bootstrapped.</p>
<p>You will find the necessary file to modify in <code>bootstrap/app.php</code>.</p>
<p>The <code>$app</code> variable is now using our extended Application class created above, and thus anytime <code>isDownForMaintenance</code> is called, the cache will be checked for the existence of the maintenance mode lock instead of the storage directory.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#75715e">/*
</span><span style="color:#75715e">|--------------------------------------------------------------------------
</span><span style="color:#75715e">| Create The Application
</span><span style="color:#75715e">|--------------------------------------------------------------------------
</span><span style="color:#75715e">|
</span><span style="color:#75715e">| The first thing we will do is create a new Laravel application instance
</span><span style="color:#75715e">| which serves as the &#34;glue&#34; for all the components of Laravel, and is
</span><span style="color:#75715e">| the IoC container for the system binding all of the various parts.
</span><span style="color:#75715e">|
</span><span style="color:#75715e">*/</span>

$app <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">App\Extensions\Illuminate\Foundation\Application</span>(
    <span style="color:#a6e22e">realpath</span>(<span style="color:#66d9ef">__DIR__</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#39;/../&#39;</span>)
);
</code></pre></div><h3 id="extending-maintenance-mode-middleware">Extending Maintenance Mode Middleware</h3>
<p>The final step that needs to be taken is to extend the maintenance mode middleware that ships with the framework.</p>
<p>This middleware is checked every time a request comes into the application. We want it to now query the cache lock that we have created instead of the storage directory.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>

<span style="color:#66d9ef">namespace</span> <span style="color:#a6e22e">App\Http\Middleware</span>;

<span style="color:#66d9ef">use</span> <span style="color:#a6e22e">App\Utils\Enums\CacheKeys</span>;
<span style="color:#66d9ef">use</span> <span style="color:#a6e22e">Cache</span>;
<span style="color:#66d9ef">use</span> <span style="color:#a6e22e">Closure</span>;
<span style="color:#66d9ef">use</span> <span style="color:#a6e22e">Illuminate\Foundation\Http\Exceptions\MaintenanceModeException</span>;
<span style="color:#66d9ef">use</span> <span style="color:#a6e22e">Illuminate\Foundation\Http\Middleware\CheckForMaintenanceMode</span> <span style="color:#66d9ef">as</span> <span style="color:#a6e22e">MaintenanceMode</span>;

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CheckForMaintenanceMode</span> <span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">MaintenanceMode</span>
{

    <span style="color:#e6db74">/**
</span><span style="color:#e6db74">     * Handle an incoming request.
</span><span style="color:#e6db74">     *
</span><span style="color:#e6db74">     * If the application is in maintenance mode, we retrieve the payload from the cache containing
</span><span style="color:#e6db74">     * the user set message and time to display on the error page when the MaintenanceModeException
</span><span style="color:#e6db74">     * is thrown.
</span><span style="color:#e6db74">     *
</span><span style="color:#e6db74">     * @param \Illuminate\Http\Request $request
</span><span style="color:#e6db74">     * @param \Closure $next
</span><span style="color:#e6db74">     * @return mixed
</span><span style="color:#e6db74">     */</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">handle</span>($request, <span style="color:#a6e22e">Closure</span> $next)
    {
        <span style="color:#66d9ef">if</span> ($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">app</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">isDownForMaintenance</span>()) {
            $data <span style="color:#f92672">=</span> <span style="color:#a6e22e">json_decode</span>(<span style="color:#a6e22e">Cache</span><span style="color:#f92672">::</span><span style="color:#a6e22e">get</span>(<span style="color:#a6e22e">CacheKeys</span><span style="color:#f92672">::</span><span style="color:#a6e22e">MAINTENANCE_PAYLOAD</span>), <span style="color:#66d9ef">true</span>);

            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">MaintenanceModeException</span>($data[<span style="color:#e6db74">&#39;time&#39;</span>], $data[<span style="color:#e6db74">&#39;retry&#39;</span>], $data[<span style="color:#e6db74">&#39;message&#39;</span>]);
        }

        <span style="color:#66d9ef">return</span> $next($request);
    }
}
</code></pre></div><p>Laravel uses the <code>\Illuminate\Foundation\Http\Middleware\CheckForMaintenanceMode::class</code> in the HTTP kernel global middleware grouping which needs to be replaced with our new custom middleware as such.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>

<span style="color:#66d9ef">use</span> <span style="color:#a6e22e">App\Http\Middleware\CheckForMaintenanceMode</span>;

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Kernel</span> <span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">HttpKernel</span>
{
    <span style="color:#e6db74">/**
</span><span style="color:#e6db74">     * The application&#39;s global HTTP middleware stack.
</span><span style="color:#e6db74">     *
</span><span style="color:#e6db74">     * These middleware are run during every request to your application.
</span><span style="color:#e6db74">     *
</span><span style="color:#e6db74">     * @var array
</span><span style="color:#e6db74">     */</span>
    <span style="color:#66d9ef">protected</span> $middleware <span style="color:#f92672">=</span> [
        <span style="color:#a6e22e">\Fideloper\Proxy\TrustProxies</span><span style="color:#f92672">::</span><span style="color:#a6e22e">class</span>,
        <span style="color:#a6e22e">CheckForMaintenanceMode</span><span style="color:#f92672">::</span><span style="color:#a6e22e">class</span>,
        <span style="color:#a6e22e">\Illuminate\Foundation\Http\Middleware\ValidatePostSize</span><span style="color:#f92672">::</span><span style="color:#a6e22e">class</span>,
        <span style="color:#a6e22e">\App\Http\Middleware\TrimStrings</span><span style="color:#f92672">::</span><span style="color:#a6e22e">class</span>,
    ];
}
</code></pre></div><p>You should now be able to call <code>php artisan down</code> and <code>php artisan up</code> to bring the application in and out of maintenance mode!</p>
<h3 id="tests">Tests</h3>
<p>Finally, its always a good idea to write tests for your code so that you can refactor in the future with more confidence.</p>
<p>I tend to write tests as I code, instead of before, to verify that something is working before I go manually test in the browser.</p>
<p>There are a couple different ways you can approach testing this feature.</p>
<p>The first is a straight forward integration test where you put the application into maintenance mode and then assert that the user cannot access the home route. That might look like the following.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">test_home_should_not_be_accessible_in_maintenance_mode</span>()
{
    <span style="color:#75715e">// Arrange
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">Artisan</span><span style="color:#f92672">::</span><span style="color:#a6e22e">call</span>(<span style="color:#e6db74">&#39;down&#39;</span>);

    $user <span style="color:#f92672">=</span> <span style="color:#a6e22e">factory</span>(<span style="color:#a6e22e">User</span><span style="color:#f92672">::</span><span style="color:#a6e22e">class</span>)<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">create</span>();

    <span style="color:#75715e">// Act &amp;&amp; Assert
</span><span style="color:#75715e"></span>    $this
        <span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">actingAs</span>($user)
        <span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">get</span>(<span style="color:#a6e22e">route</span>(<span style="color:#e6db74">&#39;home&#39;</span>))
        <span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">assertStatus</span>(<span style="color:#ae81ff">503</span>);
}
</code></pre></div><p>These next tests are arguably less valuable, but might give you more confidence when working with the codebase in the future.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">test_isDownForMaintenance_returns_true_when_in_maintenance_mode</span>()
{
    <span style="color:#75715e">// Arrange
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">Cache</span><span style="color:#f92672">::</span><span style="color:#a6e22e">forever</span>(<span style="color:#a6e22e">CacheKeys</span><span style="color:#f92672">::</span><span style="color:#a6e22e">MAINTENANCE_PAYLOAD</span>, <span style="color:#66d9ef">true</span>);

    <span style="color:#75715e">// Act &amp;&amp; Assert
</span><span style="color:#75715e"></span>    $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">assertTrue</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">app</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">isDownForMaintenance</span>());
}

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">test_isDownForMaintenance_returns_false_when_not_in_maintence_mode</span>()
{
    <span style="color:#75715e">// Arrange
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">Cache</span><span style="color:#f92672">::</span><span style="color:#a6e22e">forget</span>(<span style="color:#a6e22e">CacheKeys</span><span style="color:#f92672">::</span><span style="color:#a6e22e">MAINTENANCE_PAYLOAD</span>);

    <span style="color:#75715e">// Act &amp;&amp; Assert
</span><span style="color:#75715e"></span>    $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">assertFalse</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">app</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">isDownForMaintenance</span>());
}
</code></pre></div><p>There are many more things you could test. For example, the middleware is passing through to the next middleware in the chain when the application is not in maintenance mode or that the Up and Down commands are setting the appropriate fields in the cache.</p>
<h2 id="production-environment-performance-difference">Production Environment Performance Difference</h2>
<p>Unfortunately, I can&rsquo;t give a true apples to apples comparison as this was not tested in a controlled environment. The deployment of this upgrade also enabled the OPcache. If you aren&rsquo;t already using the OPcache, I highly recommend doing some <a href="https://medium.com/appstract/make-your-laravel-app-fly-with-php-opcache-9948db2a5f93">reading on it</a> and enabling it on your production servers.</p>
<p>That being said, our production servers (m4.large) currently have a latency of around 80ms. Your performance will differ based on where your cache is located, the size of your server, php version, etc&hellip;</p>
<h2 id="what-you-should-be-aware-of">What You Should Be Aware Of</h2>
<p>Finally, be aware that if you are using AWS Elastic Load Balancer with health checks, or a similar service, putting your app into maintenace mode will likely cause your health checks to fail.</p>
<p>You should always dry run these type of changes in a staging environment, which thankfully we did.</p>
<p>Shortly after putting the application into maintenance mode, health checks to our Laravel status endpoints began to return a 503 status code, causing the ELB to take the instances out of the rotation.</p>
<p>In hindsight, this should have been obvious.</p>
<p>A solution is to exempt your status check endpoints from the CheckForMaintenanceMode middleware, which gets run on every request.</p>
<p>To do this, you will want to follow a similar approach to how Laravel&rsquo;s <code>VerifyCsrfToken</code> middleware works.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">VerifyCsrfToken</span>
{
    <span style="color:#e6db74">/**
</span><span style="color:#e6db74">     * The URIs that should be excluded from CSRF verification.
</span><span style="color:#e6db74">     *
</span><span style="color:#e6db74">     * @var array
</span><span style="color:#e6db74">     */</span>
    <span style="color:#66d9ef">protected</span> $except <span style="color:#f92672">=</span> [];

    <span style="color:#e6db74">/**
</span><span style="color:#e6db74">     * Handle an incoming request.
</span><span style="color:#e6db74">     *
</span><span style="color:#e6db74">     * @param  \Illuminate\Http\Request  $request
</span><span style="color:#e6db74">     * @param  \Closure  $next
</span><span style="color:#e6db74">     * @return mixed
</span><span style="color:#e6db74">     *
</span><span style="color:#e6db74">     * @throws \Illuminate\Session\TokenMismatchException
</span><span style="color:#e6db74">     */</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">handle</span>($request, <span style="color:#a6e22e">Closure</span> $next)
    {
        <span style="color:#66d9ef">if</span> (
            $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">isReading</span>($request) <span style="color:#f92672">||</span>
            $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">runningUnitTests</span>() <span style="color:#f92672">||</span>
            $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">inExceptArray</span>($request) <span style="color:#f92672">||</span>
            $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">tokensMatch</span>($request)
        ) {
            <span style="color:#66d9ef">return</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">addCookieToResponse</span>($request, $next($request));
        }

        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">TokenMismatchException</span>;
    }

    <span style="color:#e6db74">/**
</span><span style="color:#e6db74">     * Determine if the request has a URI that should pass through CSRF verification.
</span><span style="color:#e6db74">     *
</span><span style="color:#e6db74">     * @param  \Illuminate\Http\Request  $request
</span><span style="color:#e6db74">     * @return bool
</span><span style="color:#e6db74">     */</span>
    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">inExceptArray</span>($request)
    {
        <span style="color:#66d9ef">foreach</span> ($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">except</span> <span style="color:#66d9ef">as</span> $except) {
            <span style="color:#66d9ef">if</span> ($except <span style="color:#f92672">!==</span> <span style="color:#e6db74">&#39;/&#39;</span>) {
                $except <span style="color:#f92672">=</span> <span style="color:#a6e22e">trim</span>($except, <span style="color:#e6db74">&#39;/&#39;</span>);
            }

            <span style="color:#66d9ef">if</span> ($request<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">is</span>($except)) {
                <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>;
            }
        }

        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>;
    }
}
</code></pre></div><p>Copy the <code>inExceptArray()</code> function to your <code>CheckForMaintenaceMode</code> middleware, which you can then check in the <code>handle()</code> function in a similar fashion to the <code>VerifyCsrfToken</code> middleware above.</p>
<h2 id="conclusion">Conclusion</h2>
<p>We moved from a filesystem based maintenance mode lock to one stored in a Redis cache.</p>
<p>If you aren&rsquo;t using Redis or a distributed cache, you can still follow the approach outlined above, just be aware that maintenance mode won&rsquo;t propogate across all your servers.</p>
<p>Whether you should use this approach, over pointing your load balancer to a static maintenance page, I leave up to you.</p>

    </div>
  </article>

  
  





  <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/posts">All posts</a></li>
         
          <li><a href="/tags">Tags</a></li>
         
          <li><a href="/about">About</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <nav id="TableOfContents">
  <ul>
    <li><a href="#why-do-we-need-maintenance-mode">Why Do We Need Maintenance Mode</a></li>
    <li><a href="#how-does-maintenance-mode-work">How Does Maintenance Mode Work</a></li>
    <li><a href="#why-the-current-solution-doesntt-work-in-a-distributed-environment">Why the Current Solution Doesnt&rsquo;t Work in a Distributed Environment</a></li>
    <li><a href="#solving-distributed-maintenance-mode">Solving Distributed Maintenance Mode.</a>
      <ul>
        <li><a href="#plan-of-attack">Plan of Attack</a></li>
        <li><a href="#creating-the-enums">Creating the Enums</a></li>
        <li><a href="#extending-artisan-down">Extending Artisan Down</a></li>
        <li><a href="#extending-artisan-up">Extending Artisan Up</a></li>
        <li><a href="#register-the-new-commands">Register the New Commands</a></li>
        <li><a href="#extend-laravels-application-class">Extend Laravel&rsquo;s Application Class</a></li>
        <li><a href="#extending-maintenance-mode-middleware">Extending Maintenance Mode Middleware</a></li>
        <li><a href="#tests">Tests</a></li>
      </ul>
    </li>
    <li><a href="#production-environment-performance-difference">Production Environment Performance Difference</a></li>
    <li><a href="#what-you-should-be-aware-of">What You Should Be Aware Of</a></li>
    <li><a href="#conclusion">Conclusion</a></li>
  </ul>
</nav>
    </div>

    <div id="share-footer" style="display: none">
      
      <ul>
  
  
    
  
  
  <li>
    <a class="icon" href="http://www.facebook.com/sharer.php?u=%2fposts%2flaravel-distributed-maintenance-mode%2f" aria-label="Facebook">
      <i class="fab fa-facebook fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://twitter.com/share?url=%2fposts%2flaravel-distributed-maintenance-mode%2f&text=Laravel%20Distributed%20Maintenance%20Mode" aria-label="Twitter">
      <i class="fab fa-twitter fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.linkedin.com/shareArticle?url=%2fposts%2flaravel-distributed-maintenance-mode%2f&title=Laravel%20Distributed%20Maintenance%20Mode" aria-label="Linkedin">
      <i class="fab fa-linkedin fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=%2fposts%2flaravel-distributed-maintenance-mode%2f&is_video=false&description=Laravel%20Distributed%20Maintenance%20Mode" aria-label="Pinterest">
      <i class="fab fa-pinterest fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="mailto:?subject=Laravel%20Distributed%20Maintenance%20Mode&body=Check out this article: %2fposts%2flaravel-distributed-maintenance-mode%2f" aria-label="Email">
      <i class="fas fa-envelope fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://getpocket.com/save?url=%2fposts%2flaravel-distributed-maintenance-mode%2f&title=Laravel%20Distributed%20Maintenance%20Mode" aria-label="Pocket">
      <i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://reddit.com/submit?url=%2fposts%2flaravel-distributed-maintenance-mode%2f&title=Laravel%20Distributed%20Maintenance%20Mode" aria-label="reddit">
      <i class="fab fa-reddit fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.tumblr.com/share/link?url=%2fposts%2flaravel-distributed-maintenance-mode%2f&name=Laravel%20Distributed%20Maintenance%20Mode&description=The%20Laravel%20maintainers%20have%20begun%20to%20invest%20more%20time%20in%20providing%20features%20and%20tooling%20for%20managing%20Laravel%20in%20a%20distributed%20environment.%0aLaravel%205.4%20modified%20the%20withoutOverlapping%28%29%20option%20for%20kernel%20tasks%20%28PR%20%2316196%29%20to%20use%20the%20cache%20to%20create%20a%20lock%20and%20prevent%20overlapping%20scheduled%20tasks%20across%20instances.%0aLaravel%20Horizon%20makes%20it%20easier%20to%20monitor%20and%20maintain%20Laravel%20powered%20Redis%20queues%20in%20both%20a%20distributed%20and%20single%20instance%20deployment.%0aLaravel%205.5%20includes%20TrustedProxy%20so%20that%20you%20can%20more%20easily%20place%20your%20application%20behind%20a%20load%20balancer." aria-label="Tumblr">
      <i class="fab fa-tumblr fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://news.ycombinator.com/submitlink?u=%2fposts%2flaravel-distributed-maintenance-mode%2f&t=Laravel%20Distributed%20Maintenance%20Mode" aria-label="Hacker News">
      <i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i>
    </a>
  </li>
</ul>

    </div>

    <div id="actions-footer">
      
        <a id="menu-toggle" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;" aria-label="Menu">
          <i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc-toggle" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;" aria-label="TOC">
          <i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share-toggle" class="icon" href="#" onclick="$('#share-footer').toggle();return false;" aria-label="Share">
          <i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" aria-label="Top of Page">
          <i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>


  <footer id="footer">
  <div class="footer-left">
    Copyright  &copy; 2021  Michael Raypold 
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
        <li><a href="/">Home</a></li>
         
        <li><a href="/posts">All posts</a></li>
         
        <li><a href="/tags">Tags</a></li>
         
        <li><a href="/about">About</a></li>
        
      </ul>
    </nav>
  </div>
</footer>


  </div>
</body>

<link rel="stylesheet" href=/lib/font-awesome/css/all.min.css>
<script src=/lib/jquery/jquery.min.js></script>
<script src=/js/main.js></script>
<script src=/js/code-copy.js></script>



</html>
